<!DOCTYPE html>
<html>
<head>
  <title>Buy <%= product.title %></title>
</head>
<body>
  <h2>Product: <%= product.title %></h2>
  <p>Price: ₹<%= product.price %></p>

  <button id="rzp-button1">Pay Now</button>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    const options = {
      key: "<%= key_id %>",
      amount: "<%= order.amount %>", // amount in paise
      currency: "INR",
      name: "MandiMart",
      description: "<%= product.title %>",
      order_id: "<%= order.id %>", // generated by backend
      image: "https://yourdomain.com/logo.png",
      prefill: {
        email: "student@example.com",
        contact: "9000000000"
      },
      config: {
        display: {
          blocks: {
            custom_block: {
              name: "Custom Pay Options",
              instruments: [
                { method: "card" },
                { method: "netbanking" }
              ]
            }
          },
          sequence: ["block.custom_block"],
          preferences: {
            show_default_blocks: false
          }
        }
      },
      handler: function (response) {
        // ✅ Send payment details to backend for verification
        fetch("/verify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature
          })
        })
        .then(res => res.text())
        .then(msg => {
          alert(msg); // "Payment Verified and Product Sold"
          window.location.href = "/"; // or /my-purchases
        })
        .catch(err => {
          console.error("Payment verification failed", err);
          alert("Payment Failed to Verify.");
        });
      },
      modal: {
        ondismiss: function () {
          if (confirm("Are you sure you want to cancel payment?")) {
            console.log("User closed Razorpay popup.");
          } else {
            console.log("User stayed.");
          }
        }
      }
    };

    const rzp1 = new Razorpay(options);

    document.getElementById("rzp-button1").onclick = function (e) {
      rzp1.open();
      e.preventDefault();
    };
  </script>
</body>
</html>
